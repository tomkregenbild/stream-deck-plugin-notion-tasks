<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Notion Tasks Settings</title>
    <style>
      body {
        font: 13px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 12px;
        color: #1f2933;
      }
      label {
        display: block;
        margin-bottom: 8px;
      }
      input {
        width: 100%;
        box-sizing: border-box;
        margin-top: 4px;
        padding: 6px;
        border: 1px solid #cbd2d9;
        border-radius: 4px;
        font: inherit;
      }
      small {
        display: block;
        margin-top: 2px;
        color: #6b7280;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background: #101828;
          color: #e2e8f0;
        }
        label {
          color: inherit;
        }
        input {
          background: #1d2939;
          border-color: #475467;
          color: #f8fafc;
        }
        small {
          color: #c7d2fe;
        }
      }
    </style>
  </head>
  <body>
    <label>
      Notion Token
      <input id="token" type="password" autocomplete="off" />
      <small>Create an internal integration and paste the secret token.</small>
    </label>
    <label>
      Database ID
      <input id="db" autocomplete="off" />
      <small>Paste the database identifier (32 characters, without spaces).</small>
    </label>
    <label>
      Status property
      <input id="statusProp" value="Status" />
    </label>
    <label>
      Done status value
      <input id="doneValue" value="Done" />
    </label>
    <label>
      Due date property
      <input id="dateProp" value="Due" />
    </label>
    <label>
      Task slot number
      <input id="position" type="number" min="1" step="1" />
      <small>Assign a slot to control which task appears on this key.</small>
    </label>
    <script>
      let websocket;
      let uuid;
      let actionUUID;
      let settings = {};

      const inputs = Array.from(document.querySelectorAll("input"));
      inputs.forEach(input => {
        input.addEventListener("input", () => {
          let value;
          if (input.type === "number") {
            value = input.value === "" ? null : Number(input.value);
          } else {
            value = input.value;
          }
          queueSave(input.id, value);
        });
      });

      const pendingUpdates = new Map();
      function queueSave(key, value) {
        pendingUpdates.set(key, value);
        scheduleSave();
      }

      let saveTimer;
      function scheduleSave() {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(flushUpdates, 250);
      }

      function flushUpdates() {
        if (!websocket || websocket.readyState !== WebSocket.OPEN) return;
        if (pendingUpdates.size === 0) return;
        const update = {};
        for (const [key, value] of pendingUpdates) {
          update[key] = value;
        }
        pendingUpdates.clear();
        settings = { ...settings, ...update };
        const payload = {
          event: "sendToPlugin",
          action: actionUUID,
          context: uuid,
          payload: update,
        };
        websocket.send(JSON.stringify(payload));
      }

      function applySettings(nextSettings) {
        settings = nextSettings || {};
      inputs.forEach(input => {
        const value = settings[input.id];
        if (value === undefined || value === null) {
          input.value = "";
          return;
        }
        input.value = value;
      });
      }

      function requestSettings() {
        if (!websocket || websocket.readyState !== WebSocket.OPEN) return;
        websocket.send(JSON.stringify({
          event: "getSettings",
          context: uuid,
        }));
      }

      function handleMessage(event) {
        const data = JSON.parse(event.data);
        if (data.event === "didReceiveSettings") {
          applySettings(data.payload?.settings ?? {});
        }
        if (data.event === "sendToPropertyInspector" && data.payload) {
          applySettings(data.payload);
        }
      }

      function initWebSocket(port, registerEvent) {
        websocket = new WebSocket(`ws://127.0.0.1:${port}`);
        websocket.onopen = () => {
          websocket.send(JSON.stringify({ event: registerEvent, uuid }));
          requestSettings();
        };
        websocket.onmessage = handleMessage;
      }

      window.connectElgatoStreamDeckSocket = function (port, pluginUUID, registerEvent, infoString) {
        uuid = pluginUUID;
        const info = JSON.parse(infoString);
        actionUUID = info?.actionInfo?.action;
        applySettings(info?.actionInfo?.payload?.settings ?? {});
        initWebSocket(port, registerEvent);
      };
    </script>
  </body>
</html>
